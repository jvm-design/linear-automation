name: Weekly Linear Pulse Summary

on:
  schedule:
    - cron: '0 17 * * 5'
  workflow_dispatch:

jobs:
  post-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get issues and post summary
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          #!/bin/bash
          
          SINCE=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
          TODAY=$(date +%d/%m/%Y)
          WEEK_AGO=$(date -d '7 days ago' +%d/%m)
          
          echo "Periode: $WEEK_AGO - $TODAY"
          
          # Get all projects
          PROJECTS=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{"query": "{ projects { nodes { id name } } }"}')
          
          echo "$PROJECTS" | jq -c '.data.projects.nodes[] | select(.name | test("^0[0-4] -"))' | while read -r project; do
            PROJECT_ID=$(echo "$project" | jq -r '.id')
            PROJECT_NAME=$(echo "$project" | jq -r '.name')
            
            echo "Processing: $PROJECT_NAME"
            
            # Get completed issues with labels
            ISSUES=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d "{\"query\": \"{ project(id: \\\"$PROJECT_ID\\\") { issues(filter: { completedAt: { gte: \\\"$SINCE\\\" } }) { nodes { identifier title labels { nodes { name } } } } } }\"}")
            
            TOTAL=$(echo "$ISSUES" | jq '.data.project.issues.nodes | length')
            
            if [ "$TOTAL" -gt 0 ] && [ "$TOTAL" != "null" ]; then
              echo "Found $TOTAL issues"
              
              # Get bugs
              BUGS_TITLES=$(echo "$ISSUES" | jq -r '[.data.project.issues.nodes[] | select(.labels.nodes[]?.name | test("bug"; "i"))] | .[].title' 2>/dev/null | head -5)
              BUGS_IDS=$(echo "$ISSUES" | jq -r '[.data.project.issues.nodes[] | select(.labels.nodes[]?.name | test("bug"; "i"))] | .[].identifier' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
              BUGS_COUNT=$(echo "$ISSUES" | jq '[.data.project.issues.nodes[] | select(.labels.nodes[]?.name | test("bug"; "i"))] | length')
              
              # Get others  
              OTHERS_TITLES=$(echo "$ISSUES" | jq -r '[.data.project.issues.nodes[] | select(([.labels.nodes[]?.name] | map(test("bug"; "i")) | any) | not)] | .[].title' 2>/dev/null | head -5)
              OTHERS_IDS=$(echo "$ISSUES" | jq -r '[.data.project.issues.nodes[] | select(([.labels.nodes[]?.name] | map(test("bug"; "i")) | any) | not)] | .[].identifier' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
              OTHERS_COUNT=$(echo "$ISSUES" | jq '[.data.project.issues.nodes[] | select(([.labels.nodes[]?.name] | map(test("bug"; "i")) | any) | not)] | length')
              
              echo "Bugs: $BUGS_COUNT, Others: $OTHERS_COUNT"
              
              # Build prompt for Claude - factual only
              PROMPT="Tu dois generer un resume factuel et technique. Pas de phrases vides sur l equipe. Juste les faits.

Bugs corriges ($BUGS_COUNT): $BUGS_TITLES
Ameliorations ($OTHERS_COUNT): $OTHERS_TITLES

Reponds UNIQUEMENT dans ce format exact (garde les emojis et sauts de ligne):

[Si bugs > 0]
Bug: [une phrase technique de 10 mots max resumant les corrections]

[Si ameliorations > 0]  
Ameliorations: [une phrase technique de 10 mots max resumant les ajouts]

Exemple de bonne reponse:
Bug: Correction du probleme de synchronisation audio et preview image.
Ameliorations: Ajout des templates photo et optimisation du workflow mobile.

Exemple de mauvaise reponse (NE PAS FAIRE):
L equipe a fait d excellents progres cette semaine..."
              
              # Call Claude
              PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rsa .)
              
              CLAUDE_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
                -H "Content-Type: application/json" \
                -H "x-api-key: $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -d "{
                  \"model\": \"claude-sonnet-4-20250514\",
                  \"max_tokens\": 150,
                  \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_ESCAPED}]
                }")
              
              SUMMARY=$(echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text // empty')
              echo "Claude summary: $SUMMARY"
              
              # Build structured body
              BODY="Semaine $WEEK_AGO au $TODAY\n\n"
              
              if [ "$BUGS_COUNT" -gt 0 ]; then
                BODY="${BODY}Bugs corriges: $BUGS_COUNT\n"
              fi
              
              if [ "$OTHERS_COUNT" -gt 0 ]; then
                BODY="${BODY}Ameliorations: $OTHERS_COUNT\n"
              fi
              
              if [ -n "$SUMMARY" ]; then
                BODY="${BODY}\n$SUMMARY\n"
              fi
              
              BODY="${BODY}\nTickets: "
              if [ -n "$BUGS_IDS" ]; then
                BODY="${BODY}$BUGS_IDS"
                if [ -n "$OTHERS_IDS" ]; then
                  BODY="${BODY}, "
                fi
              fi
              if [ -n "$OTHERS_IDS" ]; then
                BODY="${BODY}$OTHERS_IDS"
              fi
              
              # Clean for Linear API
              BODY=$(echo "$BODY" | sed 's/"/\\"/g')
              
              echo "Final body: $BODY"
              
              # Post to Linear
              RESULT=$(curl -s -X POST https://api.linear.app/graphql \
                -H "Content-Type: application/json" \
                -H "Authorization: $LINEAR_API_KEY" \
                -d "{\"query\": \"mutation { projectUpdateCreate(input: { projectId: \\\"$PROJECT_ID\\\", body: \\\"$BODY\\\" }) { success } }\"}")
              
              echo "Posted to $PROJECT_NAME"
            else
              echo "No issues, skipping"
            fi
            echo ""
          done
          
          echo "Done!"
```

## R√©sultat attendu
```
üìä Semaine 13/01 au 20/01/2026

üêõ Bugs corrig√©s: 5
‚ú® Am√©liorations: 1

Bug: Correction des probl√®mes de preview image et synchronisation assets.
Am√©liorations: Ajout de la s√©quence de prise de photo templates.

Tickets: TNS-621, TNS-619, TNS-582, TNS-580, TNS-575, TNS-574
