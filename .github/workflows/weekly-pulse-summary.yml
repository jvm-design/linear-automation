name: Weekly Linear Pulse Summary

on:
  schedule:
    # Vendredi 18h Paris = 17h UTC (hiver) / 16h UTC (√©t√©)
    - cron: '0 17 * * 5'
  workflow_dispatch:

jobs:
  post-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get completed issues and post to Pulse
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SINCE=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
          TODAY=$(date +%d/%m/%Y)
          WEEK_AGO=$(date -d '7 days ago' +%d/%m)
          
          echo "üìÖ P√©riode: $WEEK_AGO ‚Üí $TODAY"
          echo ""
          
          # R√©cup√©rer tous les projets
          PROJECTS_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{"query": "{ projects { nodes { id name } } }"}')
          
          # Filtrer seulement les projets principaux (00, 01, 02, 03)
          echo "$PROJECTS_RESPONSE" | jq -c '.data.projects.nodes[] | select(.name | test("^0[0-4] -"))' | while read -r project; do
            PROJECT_ID=$(echo "$project" | jq -r '.id')
            PROJECT_NAME=$(echo "$project" | jq -r '.name')
            
            echo "üì¶ Processing: $PROJECT_NAME"
            
            # R√©cup√©rer TOUTES les issues compl√©t√©es avec leurs labels
            ISSUES_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d "{\"query\": \"{ project(id: \\\"$PROJECT_ID\\\") { issues(filter: { completedAt: { gte: \\\"$SINCE\\\" } }) { nodes { identifier title assignee { name } labels { nodes { name } } } } } }\"}")
            
            # S√©parer BUGS et AUTRES
            BUGS=$(echo "$ISSUES_RESPONSE" | jq -r '[.data.project.issues.nodes[] | select(.labels.nodes[]?.name | test("bug"; "i"))] | unique_by(.identifier)')
            OTHERS=$(echo "$ISSUES_RESPONSE" | jq -r '[.data.project.issues.nodes[] | select((.labels.nodes | map(.name) | map(test("bug"; "i")) | any) | not)] | unique_by(.identifier)')
            
            BUGS_COUNT=$(echo "$BUGS" | jq 'length')
            OTHERS_COUNT=$(echo "$OTHERS" | jq 'length')
            
            echo "  üêõ Bugs: $BUGS_COUNT"
            echo "  ‚ú® Autres: $OTHERS_COUNT"
            
            TOTAL=$((BUGS_COUNT + OTHERS_COUNT))
            
            if [ "$TOTAL" -gt 0 ]; then
              
              # Pr√©parer les listes pour Claude
              BUGS_LIST=$(echo "$BUGS" | jq -r '.[] | "- \(.identifier): \(.title)"' | head -15)
              OTHERS_LIST=$(echo "$OTHERS" | jq -r '.[] | "- \(.identifier): \(.title)"' | head -15)
              
              # Appeler Claude pour g√©n√©rer le r√©sum√© ex√©cutif
              CLAUDE_PROMPT="Tu es un assistant qui r√©dige des r√©sum√©s ex√©cutifs concis pour des updates de projet.

Voici les tickets compl√©t√©s cette semaine pour le projet ${PROJECT_NAME}:

BUGS CORRIG√âS (${BUGS_COUNT}):
${BUGS_LIST}

AUTRES TICKETS (${OTHERS_COUNT}):
${OTHERS_LIST}

G√©n√®re un r√©sum√© ex√©cutif en fran√ßais avec:
1. Un titre accrocheur avec emoji
2. Une section 'üêõ Bugs corrig√©s' (2-3 phrases r√©sumant les corrections importantes)
3. Une section '‚ú® Am√©liorations' (2-3 phrases r√©sumant les autres tickets)
4. Une ligne de conclusion

Format: texte simple, pas de markdown complexe. Maximum 500 caract√®res."

              # √âchapper le prompt pour JSON
              CLAUDE_PROMPT_ESCAPED=$(echo "$CLAUDE_PROMPT" | jq -Rs '.')
              
              CLAUDE_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
                -H "Content-Type: application/json" \
                -H "x-api-key: $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -d "{
                  \"model\": \"claude-sonnet-4-20250514\",
                  \"max_tokens\": 600,
                  \"messages\": [{\"role\": \"user\", \"content\": $CLAUDE_PROMPT_ESCAPED}]
                }")
              
              SUMMARY=$(echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text // "Erreur g√©n√©ration r√©sum√©"')
              
              echo "  üìù R√©sum√© g√©n√©r√©"
              
              # Nettoyer pour Linear
              BODY="Semaine du ${WEEK_AGO} au ${TODAY}\n\n${SUMMARY}"
              BODY=$(echo "$BODY" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/\\n/\\n/g' | cut -c1-1000)
              
              # Poster sur Pulse
              RESULT=$(curl -s -X POST https://api.linear.app/graphql \
                -H "Content-Type: application/json" \
                -H "Authorization: $LINEAR_API_KEY" \
                -d "{\"query\": \"mutation { projectUpdateCreate(input: { projectId: \\\"$PROJECT_ID\\\", body: \\\"$BODY\\\" }) { success } }\"}")
              
              SUCCESS=$(echo "$RESULT" | jq -r '.data.projectUpdateCreate.success // false')
              
              if [ "$SUCCESS" == "true" ]; then
                echo "  ‚úÖ Posted to $PROJECT_NAME"
              else
                echo "  ‚ùå Error: $RESULT"
              fi
            else
              echo "  ‚è≠Ô∏è No completed issues, skipping"
            fi
            
            echo ""
          done
          
          echo "üéâ Done!"
