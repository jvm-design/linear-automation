name: Weekly Linear Pulse Summary

on:
  schedule:
    - cron: '0 16 * * 5'
  workflow_dispatch:

jobs:
  post-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get completed issues and post to Pulse
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          SINCE=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
          TODAY=$(date +%d/%m/%Y)
          WEEK_AGO=$(date -d '7 days ago' +%d/%m)
          
          echo "üìÖ P√©riode: $WEEK_AGO ‚Üí $TODAY"
          echo ""
          
          # R√©cup√©rer tous les projets avec leurs vrais UUIDs
          PROJECTS_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{"query": "{ projects { nodes { id name } } }"}')
          
          echo "Projects found:"
          echo "$PROJECTS_RESPONSE" | jq -r '.data.projects.nodes[] | "  - \(.name): \(.id)"'
          echo ""
          
          # Pour chaque projet
          echo "$PROJECTS_RESPONSE" | jq -c '.data.projects.nodes[]' | while read -r project; do
            PROJECT_ID=$(echo "$project" | jq -r '.id')
            PROJECT_NAME=$(echo "$project" | jq -r '.name')
            
            echo "üì¶ Processing: $PROJECT_NAME"
            
            # R√©cup√©rer les issues compl√©t√©es cette semaine
            ISSUES_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
              -H "Content-Type: application/json" \
              -H "Authorization: $LINEAR_API_KEY" \
              -d "{\"query\": \"{ project(id: \\\"$PROJECT_ID\\\") { issues(filter: { completedAt: { gte: \\\"$SINCE\\\" } }) { nodes { identifier title assignee { name } } } } }\"}")
            
            COUNT=$(echo "$ISSUES_RESPONSE" | jq '.data.project.issues.nodes | length' 2>/dev/null || echo "0")
            echo "  Found $COUNT issues"
            
            if [ "$COUNT" -gt 0 ] && [ "$COUNT" != "null" ]; then
              
              # Liste simple des tickets
              ISSUES_LIST=$(echo "$ISSUES_RESPONSE" | jq -r '.data.project.issues.nodes[] | "\(.identifier) \(.title)"' 2>/dev/null | head -10 | tr '\n' ', ' | sed 's/,$//')
              
              # Body simple
              BODY="Semaine du ${WEEK_AGO} au ${TODAY} - ${COUNT} tickets completes: ${ISSUES_LIST}"
              
              # Nettoyer les caract√®res probl√©matiques
              BODY=$(echo "$BODY" | sed 's/[\"\\]//g' | tr -d '\n' | cut -c1-500)
              
              # Poster sur Pulse
              RESULT=$(curl -s -X POST https://api.linear.app/graphql \
                -H "Content-Type: application/json" \
                -H "Authorization: $LINEAR_API_KEY" \
                -d "{\"query\": \"mutation { projectUpdateCreate(input: { projectId: \\\"$PROJECT_ID\\\", body: \\\"$BODY\\\" }) { success projectUpdate { id } } }\"}")
              
              SUCCESS=$(echo "$RESULT" | jq -r '.data.projectUpdateCreate.success' 2>/dev/null)
              
              if [ "$SUCCESS" == "true" ]; then
                echo "  ‚úÖ Posted to $PROJECT_NAME"
              else
                echo "  ‚ùå Error: $RESULT"
              fi
            else
              echo "  ‚è≠Ô∏è No completed issues, skipping"
            fi
            
            echo ""
          done
          
          echo "üéâ Done!"
